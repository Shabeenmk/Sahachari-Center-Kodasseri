<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahachari Center Kodasseri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom color overrides */
        :root {
            --primary-blue: #3758cd;
            --primary-pink: #c5006b;
            --teal: #14b8a6;
        }
        .bg-primary-blue { background-color: var(--primary-blue); }
        .bg-primary-pink { background-color: var(--primary-pink); }
        .bg-teal { background-color: var(--teal); }
        .text-primary-blue { color: var(--primary-blue); }
        .text-primary-pink { color: var(--primary-pink); }
        .hover\:bg-primary-blue-dark:hover { background-color: #2e49a8; }
        .hover\:bg-primary-pink-dark:hover { background-color: #a00056; }
        .hover\:bg-teal-dark:hover { background-color: #0f766e; }
        .focus\:ring-primary-blue { outline-color: var(--primary-blue); }
        .focus\:ring-primary-pink { outline-color: var(--primary-pink); }
        /* Bottom nav adjustments */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }
        /* Theme styles */
        .theme-light {
            background-color: #ffffff;
            color: #1f2937;
        }
        .theme-light .bg-white { background-color: #ffffff; }
        .theme-light .bg-blue-100 { background-color: #dbeafe; }
        .theme-light .text-gray-800 { color: #1f2937; }
        .theme-light .text-gray-600 { color: #4b5563; }
        .theme-light .inventory-card {
            background-color: #ffffff;
            color: #1f2937;
        }
        .theme-light .details-box {
            border-color: #d1d5db;
        }
        .theme-light .details-box input,
        .theme-light textarea,
        .theme-light #entryDealer,
        .theme-light #entryDate,
        .theme-light #returnItems,
        .theme-light #returnEntries,
        .theme-light #returnDate,
        .theme-light #editTotalInput,
        .theme-light #editEntryDealer,
        .theme-light #editEntryDate,
        .theme-light #tokenInput {
            background-color: #f9fafb;
            border-color: #d1d5db;
            color: #1f2937;
        }
        .theme-light .details-box input:focus,
        .theme-light textarea:focus,
        .theme-light #entryDealer:focus,
        .theme-light #entryDate:focus,
        .theme-light #returnItems:focus,
        .theme-light #returnEntries:focus,
        .theme-light #returnDate:focus,
        .theme-light #editTotalInput:focus,
        .theme-light #editEntryDealer:focus,
        .theme-light #editEntryDate:focus,
        .theme-light #tokenInput:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(55, 88, 205, 0.2);
        }
        .theme-light .text-header,
        .theme-light .text-subheader {
            color: #1f2937;
        }
        .theme-light .text-status-issued { color: #dc2626; }
        .theme-light .text-status-returned { color: #16a34a; }
        .theme-light .text-status-partial { color: #d97706; }
        .theme-dark {
            background-color: #1f2937;
            color: #d1d5db;
        }
        .theme-dark .bg-white { background-color: #374151; }
        .theme-dark .bg-blue-100 { background-color: #4b5e77; }
        .theme-dark .text-gray-800 { color: #d1d5db; }
        .theme-dark .text-gray-600 { color: #9ca3af; }
        .theme-dark .inventory-card {
            background-color: #374151;
            color: #d1d5db;
        }
        .theme-dark .details-box {
            border-color: #4b5e77;
        }
        .theme-dark .details-box input,
        .theme-dark textarea,
        .theme-dark #entryDealer,
        .theme-dark #entryDate,
        .theme-dark #returnItems,
        .theme-dark #returnEntries,
        .theme-dark #returnDate,
        .theme-dark #editTotalInput,
        .theme-dark #editEntryDealer,
        .theme-dark #editEntryDate,
        .theme-dark #tokenInput {
            background-color: #4b5e77;
            border-color: #6b7280;
            color: #d1d5db;
        }
        .theme-dark .details-box input:focus,
        .theme-dark textarea:focus,
        .theme-dark #entryDealer:focus,
        .theme-dark #entryDate:focus,
        .theme-dark #returnItems:focus,
        .theme-dark #returnEntries:focus,
        .theme-dark #returnDate:focus,
        .theme-dark #editTotalInput:focus,
        .theme-dark #editEntryDealer:focus,
        .theme-dark #editEntryDate:focus,
        .theme-dark #tokenInput:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(55, 88, 205, 0.3);
        }
        .theme-dark .text-header,
        .theme-dark .text-subheader {
            color: #d1d5db;
        }
        .theme-dark .text-status-issued { color: #ef4444; }
        .theme-dark .text-status-returned { color: #22c55e; }
        .theme-dark .text-status-partial { color: #f59e0b; }
        .theme-pitchblack {
            background-color: #000000;
            color: #ffffff;
        }
        .theme-pitchblack .bg-white { background-color: #1a1a1a; }
        .theme-pitchblack .bg-blue-100 { background-color: #333333; }
        .theme-pitchblack .text-gray-800 { color: #ffffff; }
        .theme-pitchblack .text-gray-600 { color: #9ca3af; }
        .theme-pitchblack .inventory-card {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .theme-pitchblack .details-box {
            border-color: #333333;
        }
        .theme-pitchblack .details-box input,
        .theme-pitchblack textarea,
        .theme-pitchblack #entryDealer,
        .theme-pitchblack #entryDate,
        .theme-pitchblack #returnItems,
        .theme-pitchblack #returnEntries,
        .theme-pitchblack #returnDate,
        .theme-pitchblack #editTotalInput,
        .theme-pitchblack #editEntryDealer,
        .theme-pitchblack #editEntryDate,
        .theme-pitchblack #tokenInput {
            background-color: #333333;
            border-color: #4b5e77;
            color: #ffffff;
        }
        .theme-pitchblack .details-box input:focus,
        .theme-pitchblack textarea:focus,
        .theme-pitchblack #entryDealer:focus,
        .theme-pitchblack #entryDate:focus,
        .theme-pitchblack #returnItems:focus,
        .theme-pitchblack #returnEntries:focus,
        .theme-pitchblack #returnDate:focus,
        .theme-pitchblack #editTotalInput:focus,
        .theme-pitchblack #editEntryDealer:focus,
        .theme-pitchblack #editEntryDate:focus,
        .theme-pitchblack #tokenInput:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(55, 88, 205, 0.4);
        }
        .theme-pitchblack .text-header,
        .theme-pitchblack .text-subheader {
            color: #ffffff;
        }
        .theme-pitchblack .text-status-issued { color: #f87171; }
        .theme-pitchblack .text-status-returned { color: #4ade80; }
        .theme-pitchblack .text-status-partial { color: #fbbf24; }
        /* FAB and Modal styles */
        .fab {
            position: fixed;
            bottom: 75px;
            right: 20px;
            z-index: 30;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 40;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        /* Warning styles */
        .warning {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        /* Details box styling */
        .details-box {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        .details-box input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
        }
        .details-box input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(55, 88, 205, 0.2);
        }
        /* Card view styles */
        .inventory-card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .inventory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .item-image {
            width: 260px; /* Uniform width */
            height: 180px; /* Uniform height */
            object-fit: contain; /* Preserve aspect ratio, show entire image */
            object-position: center; /* Center the image within the container */
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background-color: #f3f4f6;
            margin: 0 auto 1rem auto; /* Center the image horizontally and add bottom margin */
            display: block; /* Ensure the image is a block element for centering */
        }
        /* Stat styling */
        .stat-label {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
        }
        .stat-label i {
            margin-right: 0.5rem;
            color: #9ca3af;
        }
        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
        }
        .stat-total {
            background-color: #e0e7ff;
            color: #4b5e77;
            cursor: default;
        }
        .stat-total-editable {
            background-color: #e0e7ff;
            color: #4b5e77;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .stat-total-editable:hover {
            background-color: #c7d2fe;
        }
        .stat-issued { background-color: #fee2e2; color: #dc2626; }
        .stat-available {
            background-color: #dcfce7;
            color: #16a34a;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .theme-dark .stat-total { background-color: #5a6794; color: #e0e7ff; }
        .theme-dark .stat-total-editable {
            background-color: #5a6794;
            color: #e0e7ff;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .theme-dark .stat-total-editable:hover {
            background-color: #6b7280;
        }
        .theme-dark .stat-issued { background-color: #7f2a2a; color: #fee2e2; }
        .theme-dark .stat-available {
            background-color: #3f6b48;
            color: #dcfce7;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .theme-pitchblack .stat-total { background-color: #3b4a6b; color: #e0e7ff; }
        .theme-pitchblack .stat-total-editable {
            background-color: #3b4a6b;
            color: #e0e7ff;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .theme-pitchblack .stat-total-editable:hover {
            background-color: #4b5e77;
        }
        .theme-pitchblack .stat-issued { background-color: #5a1e1e; color: #fee2e2; }
        .theme-pitchblack .stat-available {
            background-color: #2e4b36;
            color: #dcfce7;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        /* Disabled item styling */
        .disabled-item {
            color: #9ca3af;
            cursor: not-allowed;
        }
        .disabled-item input {
            cursor: not-allowed;
        }
        /* Status styling */
        .status-text {
            font-weight: bold;
        }
    </style>
</head>
<body class="font-sans theme-system">
    <!-- Header -->
    <header class="bg-primary-blue text-white p-4 flex justify-between items-center shadow-md">
        <h1 class="text-xl font-bold text-header">Sahachari Center Kodasseri</h1>
    </header>

    <!-- Main Content -->
    <main class="p-6 pb-16">
        <!-- Stock Info Section -->
        <section id="stockInfoSection" class="section">
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-primary-blue flex items-center"><i class="fas fa-cubes mr-2"></i> Stock Info</h2>
                <div class="inventory-grid" id="inventoryGrid"></div>
            </div>
            <!-- Stock Info FAB Button -->
            <button id="stockFabBtn" class="fab bg-primary-pink text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-primary-pink-dark transition duration-200" onclick="toggleEditMode()">
                <i id="stockFabIcon" class="fas fa-edit text-xl"></i>
            </button>
            <!-- Edit Total Modal -->
            <div id="editTotalModal" class="modal modal-hidden" onclick="closeEditTotalModal(event)">
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary-blue">Edit Total Stock</h3>
                    <div class="flex flex-col space-y-4">
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Item: <span id="editItemName"></span></label>
                        </div>
                        <div>
                            <label for="editTotalInput" class="text-sm font-medium text-primary-blue">New Total</label>
                            <input id="editTotalInput" type="number" min="0" class="p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-primary-blue">
                            <p id="editTotalWarning" class="warning">Total must be greater than or equal to the current issued count (<span id="currentIssued"></span>)</p>
                        </div>
                        <div class="flex space-x-3 mt-4">
                            <button onclick="closeEditTotalModal()" class="flex-1 bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition duration-200">Cancel</button>
                            <button onclick="saveTotal()" class="flex-1 bg-primary-blue text-white p-3 rounded-lg hover:bg-primary-blue-dark transition duration-200">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Register Section -->
        <section id="registerSection" class="section hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-primary-blue flex items-center"><i class="fas fa-book mr-2"></i> Register</h2>
                <div class="overflow-x-auto">
                    <table id="logTable" class="min-w-full border rounded-lg">
                        <thead>
                            <tr class="bg-blue-100">
                                <th class="py-3 px-4 border">Details</th>
                                <th class="py-3 px-4 border">Remarks</th>
                                <th class="py-3 px-4 border">Issued Items</th>
                                <th class="py-3 px-4 border">Returned Items</th>
                                <th class="py-3 px-4 border">Dealer Name</th>
                                <th class="py-3 px-4 border">Issue Date</th>
                                <th class="py-3 px-4 border">Return Date</th>
                                <th class="py-3 px-4 border">Status</th>
                                <th class="py-3 px-4 border">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- FAB Button -->
            <button id="fabBtn" class="fab bg-primary-pink text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-primary-pink-dark transition duration-200">
                <i class="fas fa-plus text-xl"></i>
            </button>

            <!-- FAB Options Modal -->
            <div id="fabOptionsModal" class="modal modal-hidden" onclick="closeFabOptionsModal(event)">
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-xs w-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary-blue">Select Action</h3>
                    <div class="flex flex-col space-y-3">
                        <button onclick="showAddEntryModal()" class="bg-primary-blue text-white px-4 py-2 rounded-lg hover:bg-primary-blue-dark transition duration-200 flex items-center justify-center">
                            <i class="fas fa-arrow-up mr-2"></i> Issue
                        </button>
                        <button onclick="showReturnModal()" class="bg-primary-pink text-white px-4 py-2 rounded-lg hover:bg-primary-pink-dark transition duration-200 flex items-center justify-center">
                            <i class="fas fa-arrow-down mr-2"></i> Return
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Entry Modal -->
            <div id="addEntryModal" class="modal modal-hidden" onclick="closeAddEntryModal(event)">
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary-blue">Add Entry</h3>
                    <div class="flex flex-col space-y-4">
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Details</label>
                            <div class="details-box">
                                <input id="entryName" type="text" placeholder="Name" class="focus:outline-none focus:ring-2 focus:ring-primary-blue" oninput="capitalizeFirstLetters(this)">
                                <input id="entryPlace" type="text" placeholder="Place" class="focus:outline-none focus:ring-2 focus:ring-primary-blue" oninput="capitalizeFirstLetters(this)">
                                <input id="entryPhone" type="tel" placeholder="Phone (10 Digits)" pattern="[0-9]{10}" maxlength="10" class="focus:outline-none focus:ring-2 focus:ring-primary-blue">
                            </div>
                            <p id="detailsWarning" class="warning">All details (Name, Place, Phone) are required, Phone must be 10 digits</p>
                        </div>
                        <textarea id="entryRemarks" placeholder="Remarks (If any)" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue" rows="2"></textarea>
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Choose Items</label>
                            <div id="entryItems" class="border rounded-lg p-3 max-h-40 overflow-y-auto">
                                <!-- Checkboxes will be populated dynamically -->
                            </div>
                            <p id="itemsWarning" class="warning">Please select an item</p>
                        </div>
                        <input id="entryDealer" type="text" placeholder="Dealer Name" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue" oninput="capitalizeFirstLetters(this)">
                        <div>
                            <label for="entryDate" class="text-sm font-medium text-primary-blue">Issue Date</label>
                            <div class="flex space-x-2">
                                <input id="entryDate" type="date" max="2025-05-16" class="p-3 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-primary-blue">
                                <button onclick="setTodayDate()" class="bg-teal text-white p-3 rounded-lg hover:bg-teal-dark transition duration-200">Today</button>
                            </div>
                            <p id="dateWarning" class="warning">Issue date is required</p>
                        </div>
                        <div class="flex space-x-3 mt-4">
                            <button onclick="closeAddEntryModal()" class="flex-1 bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition duration-200">Cancel</button>
                            <button onclick="clearForm()" class="flex-1 bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition duration-200">Clear Form</button>
                            <button onclick="addEntry()" class="flex-1 bg-primary-blue text-white p-3 rounded-lg hover:bg-primary-blue-dark transition duration-200">Enter</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Entry Modal -->
            <div id="editEntryModal" class="modal modal-hidden" onclick="closeEditEntryModal(event)">
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary-blue">Edit Entry</h3>
                    <div class="flex flex-col space-y-4">
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Details</label>
                            <div class="details-box">
                                <input id="editEntryName" type="text" placeholder="Name" class="focus:outline-none focus:ring-2 focus:ring-primary-blue" oninput="capitalizeFirstLetters(this)">
                                <input id="editEntryPlace" type="text" placeholder="Place" class="focus:outline-none focus:ring-2 focus:ring-primary-blue" oninput="capitalizeFirstLetters(this)">
                                <input id="editEntryPhone" type="tel" placeholder="Phone (10 Digits)" pattern="[0-9]{10}" maxlength="10" class="focus:outline-none focus:ring-2 focus:ring-primary-blue">
                            </div>
                            <p id="editDetailsWarning" class="warning">All details (Name, Place, Phone) are required, Phone must be 10 digits</p>
                        </div>
                        <textarea id="editEntryRemarks" placeholder="Remarks (If any)" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue" rows="2"></textarea>
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Choose Items to Issue</label>
                            <div id="editEntryItems" class="border rounded-lg p-3 max-h-40 overflow-y-auto">
                                <!-- Checkboxes will be populated dynamically -->
                            </div>
                            <p id="editItemsWarning" class="warning">Please select an item</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Returned Items (Select to Undo Return)</label>
                            <div id="editReturnedItems" class="border rounded-lg p-3 max-h-40 overflow-y-auto">
                                <!-- Checkboxes for returned items will be populated dynamically -->
                            </div>
                            <p id="editReturnedItemsNote" class="text-sm text-gray-600 mt-1">Unchecking an item will undo its return and mark it as issued again.</p>
                        </div>
                        <input id="editEntryDealer" type="text" placeholder="Dealer Name" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue" oninput="capitalizeFirstLetters(this)">
                        <div>
                            <label for="editEntryDate" class="text-sm font-medium text-primary-blue">Issue Date</label>
                            <div class="flex space-x-2">
                                <input id="editEntryDate" type="date" max="2025-05-16" class="p-3 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-primary-blue">
                                <button onclick="setTodayEditDate()" class="bg-teal text-white p-3 rounded-lg hover:bg-teal-dark transition duration-200">Today</button>
                            </div>
                            <p id="editDateWarning" class="warning">Issue date is required</p>
                        </div>
                        <div class="flex space-x-3 mt-4">
                            <button onclick="closeEditEntryModal()" class="flex-1 bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition duration-200">Cancel</button>
                            <button onclick="saveEditedEntry()" class="flex-1 bg-primary-blue text-white p-3 rounded-lg hover:bg-primary-blue-dark transition duration-200">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Return Modal -->
            <div id="returnModal" class="modal modal-hidden" onclick="closeReturnModal(event)">
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary-blue">Return</h3>
                    <div class="flex flex-col space-y-4">
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Choose Item to Return</label>
                            <div id="returnItems" class="border rounded-lg p-3 max-h-40 overflow-y-auto">
                                <!-- Radio buttons will be populated dynamically -->
                            </div>
                            <p id="returnItemsWarning" class="warning">Please select an item to return</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-primary-blue">Choose Entry</label>
                            <select id="returnEntries" class="p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-primary-blue">
                                <option value="">Select an entry</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <p id="returnEntryWarning" class="warning">Please select an entry to return</p>
                        </div>
                        <div>
                            <label for="returnDate" class="text-sm font-medium text-primary-blue">Return Date</label>
                            <div class="flex space-x-2">
                                <input id="returnDate" type="date" max="2025-05-16" class="p-3 border rounded-lg flex-1 focus:outline-none focus:ring-2 focus:ring-primary-blue">
                                <button onclick="setTodayReturnDate()" class="bg-teal text-white p-3 rounded-lg hover:bg-teal-dark transition duration-200">Today</button>
                            </div>
                            <p id="returnDateWarning" class="warning">Return date is required</p>
                        </div>
                        <div class="flex space-x-3 mt-4">
                            <button onclick="closeReturnModal()" class="flex-1 bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition duration-200">Cancel</button>
                            <button onclick="markAsReturned()" class="flex-1 bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition duration-200">Mark as Return</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div id="deleteConfirmModal" class="modal modal-hidden" onclick="closeDeleteConfirmModal(event)">
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                    <h3 class="text-lg font-semibold mb-4 text-primary-blue">Confirm Deletion</h3>
                    <p class="text-gray-600 mb-4">Are you sure you want to delete this entry? This action cannot be undone.</p>
                    <div class="flex space-x-3">
                        <button onclick="closeDeleteConfirmModal()" class="flex-1 bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition duration-200">Cancel</button>
                        <button id="confirmDeleteBtn" class="flex-1 bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition duration-200">Delete</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settingsSection" class="section hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-md mx-auto">
                <h2 class="text-2xl font-semibold mb-4 text-primary-blue flex items-center"><i class="fas fa-cog mr-2"></i> Settings</h2>
                <div class="flex flex-col space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-2 text-primary-blue flex items-center"><i class="fas fa-paint-roller mr-2"></i> Change Theme</h3>
                        <select id="themeSelect" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue" onchange="changeTheme()">
                            <option value="system" selected>System</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="pitchblack">Pitchblack</option>
                        </select>
                    </div>
                    <div id="dealerLoginCard" class="bg-white p-4 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-2 text-primary-blue flex items-center"><i class="fas fa-user-lock mr-2"></i> Dealer Login</h3>
                        <button onclick="showSection('dealerLogin')" class="bg-primary-blue text-white px-4 py-2 rounded-lg hover:bg-primary-blue-dark transition duration-200 flex items-center justify-center w-full">
                            <i class="fas fa-sign-in-alt mr-2"></i> Login as Dealer
                        </button>
                    </div>
                    <div id="logoutCard" class="bg-white p-4 rounded-lg shadow-lg hidden">
                        <h3 class="text-lg font-semibold mb-2 text-primary-blue flex items-center"><i class="fas fa-sign-out-alt mr-2"></i> Logout</h3>
                        <button onclick="logoutDealer()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 flex items-center justify-center w-full">
                            <i class="fas fa-sign-out-alt mr-2"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dealer Login Section -->
        <section id="dealerLoginSection" class="section hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-md mx-auto">
                <h2 class="text-2xl font-semibold mb-4 text-primary-blue flex items-center"><i class="fas fa-user-lock mr-2"></i> Dealer Login</h2>
                <div class="flex flex-col space-y-4">
                    <div>
                        <label for="tokenInput" class="text-sm font-medium text-primary-blue">Enter Token</label>
                        <div class="details-box">
                            <input id="tokenInput" type="text" placeholder="Enter your token" class="focus:outline-none focus:ring-2 focus:ring-primary-blue">
                        </div>
                        <p id="tokenWarning" class="warning">Token is required</p>
                    </div>
                    <div class="flex space-x-3 mt-4">
                        <button onclick="showSection('settings')" class="flex-1 bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition duration-200">Cancel</button>
                        <button onclick="loginDealer()" class="flex-1 bg-primary-blue text-white p-3 rounded-lg hover:bg-primary-blue-dark transition duration-200">Login</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Token Warning Modal -->
        <div id="tokenWarningModal" class="modal modal-hidden" onclick="closeTokenWarningModal(event)">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                <h3 class="text-lg font-semibold mb-4 text-primary-blue">Invalid Token</h3>
                <p class="text-gray-600 mb-4">The given token is invalid, this is not for you.</p>
                <div class="flex justify-center">
                    <button onclick="closeTokenWarningModal()" class="bg-primary-blue text-white p-3 rounded-lg hover:bg-primary-blue-dark transition duration-200">OK</button>
                </div>
            </div>
        </div>

        <!-- Success Login Modal -->
        <div id="successLoginModal" class="modal modal-hidden" onclick="closeSuccessLoginModal(event)">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                <h3 class="text-lg font-semibold mb-4 text-primary-blue">Login Successful</h3>
                <p class="text-gray-600 mb-4">Congratulations, you have been logged in as a Dealer, now you can work on Register.</p>
                <div class="flex justify-center">
                    <button onclick="closeSuccessLoginModal()" class="bg-primary-blue text-white p-3 rounded-lg hover:bg-primary-blue-dark transition duration-200">OK</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav bg-primary-blue text-white p-2 shadow-lg">
        <ul class="flex justify-around">
            <li>
                <button onclick="showSection('stockInfo')" class="flex flex-col items-center py-1 px-4 hover:bg-primary-blue-dark rounded">
                    <i class="fas fa-cubes text-lg"></i>
                    <span class="text-xs mt-1">Stock Info</span>
                </button>
            </li>
            <li>
                <button onclick="showSection('register')" class="flex flex-col items-center py-1 px-4 hover:bg-primary-blue-dark rounded">
                    <i class="fas fa-book text-lg"></i>
                    <span class="text-xs mt-1">Register</span>
                </button>
            </li>
            <li>
                <button onclick="showSection('settings')" class="flex flex-col items-center py-1 px-4 hover:bg-primary-blue-dark rounded">
                    <i class="fas fa-cog text-lg"></i>
                    <span class="text-xs mt-1">Settings</span>
                </button>
            </li>
        </ul>
    </nav>

    <script>
        // Inventory data
        let inventory = [
            { name: "Air bed", total: 7, issued: 0 },
            { name: "Axillary crutches", total: 4, issued: 0 },
            { name: "Backrest", total: 2, issued: 0 },
            { name: "Commode chair", total: 7, issued: 0 },
            { name: "Elbow crutches", total: 4, issued: 0 },
            { name: "Folding walker", total: 11, issued: 0 },
            { name: "Hospital bed", total: 6, issued: 0 },
            { name: "Hospital Cot", total: 1, issued: 0 },
            { name: "Hospital cot commode", total: 1, issued: 0 },
            { name: "IV Stand", total: 4, issued: 0 },
            { name: "Nebulizer", total: 1, issued: 0 },
            { name: "Oxygen Cylinder", total: 2, issued: 0 },
            { name: "Water bed", total: 2, issued: 0 },
            { name: "Wheel chair", total: 7, issued: 0 }
        ].sort((a, b) => a.name.localeCompare(b.name));

        // Sample data for logs (empty, will be populated by Add Entry form)
        let logs = [];

        // State to track edit mode and dealer login
        let isEditMode = false;
        let deleteIndex = null; // To store the index for deletion
        let isDealerLoggedIn = false; // Track dealer login status
        const dealerToken = "sahachari2025"; // Unique token for dealer login

        // Function to capitalize the first letter of each word in an input field
        function capitalizeFirstLetters(input) {
            const words = input.value.split(" ");
            for (let i = 0; i < words.length; i++) {
                if (words[i].length > 0) {
                    words[i] = words[i][0].toUpperCase() + words[i].substring(1).toLowerCase();
                }
            }
            input.value = words.join(" ");
        }

        // Load inventory as cards
        function loadInventory() {
            const grid = document.getElementById("inventoryGrid");
            grid.innerHTML = "";
            inventory.forEach((item, index) => {
                const available = Math.max(0, item.total - item.issued); // Ensure Available doesn't go negative
                const card = document.createElement("div");
                card.className = "inventory-card";
                card.setAttribute("data-index", index);
                card.innerHTML = `
                    <img src="images/${item.name.toLowerCase().replace(/\s+/g, '-')}.jpg" alt="${item.name}" class="item-image" onerror="this.src='https://via.placeholder.com/260x180?text=${item.name}'">
                    <p class="text-lg font-semibold text-gray-800 mb-3">${item.name}</p>
                    <div class="flex justify-between items-center mb-2">
                        <span class="stat-label"><i class="fas fa-boxes"></i> Total:</span>
                        <span class="stat-value stat-total${isEditMode ? '-editable' : ''}" onclick="isEditMode && showEditTotalModal(${index})">${item.total}</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="stat-label"><i class="fas fa-arrow-up"></i> Issued:</span>
                        <span class="stat-value stat-issued">${item.issued}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="stat-label"><i class="fas fa-check-circle"></i> Available:</span>
                        <span class="stat-value stat-available">${available}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const icon = document.getElementById("stockFabIcon");
            icon.className = isEditMode ? "fas fa-times text-xl" : "fas fa-edit text-xl";
            loadInventory(); // Refresh cards to apply clickable total
        }

        // Show Edit Total modal
        function showEditTotalModal(index) {
            const item = inventory[index];
            document.getElementById("editItemName").textContent = item.name;
            document.getElementById("editTotalInput").value = item.total;
            document.getElementById("currentIssued").textContent = item.issued;
            document.getElementById("editTotalModal").setAttribute("data-index", index);
            document.getElementById("editTotalModal").classList.remove("modal-hidden");
            document.getElementById("editTotalModal").classList.add("modal-visible");
            document.getElementById("editTotalWarning").style.display = "none";
        }

        // Close Edit Total modal
        function closeEditTotalModal(event) {
            const modalContent = document.querySelector("#editTotalModal .bg-white");
            if (event && !modalContent.contains(event.target)) {
                document.getElementById("editTotalModal").classList.add("modal-hidden");
                document.getElementById("editTotalModal").classList.remove("modal-visible");
                document.getElementById("editTotalInput").value = "";
                document.getElementById("editTotalWarning").style.display = "none";
            } else if (!event) {
                document.getElementById("editTotalModal").classList.add("modal-hidden");
                document.getElementById("editTotalModal").classList.remove("modal-visible");
                document.getElementById("editTotalInput").value = "";
                document.getElementById("editTotalWarning").style.display = "none";
            }
        }

        // Save new Total value
        function saveTotal() {
            const index = parseInt(document.getElementById("editTotalModal").getAttribute("data-index"));
            const newTotal = parseInt(document.getElementById("editTotalInput").value);
            const item = inventory[index];
            const currentIssued = item.issued;

            // Validation: New total must be greater than or equal to issued count
            if (isNaN(newTotal) || newTotal < currentIssued) {
                document.getElementById("editTotalWarning").style.display = "block";
                return;
            }

            // Update the total
            item.total = newTotal;

            // Update views
            loadInventory();
            populateItemsCheckboxes();
            closeEditTotalModal();
            alert(`Total stock for ${item.name} updated successfully!`);
        }

        // Load register table
        function loadLogs() {
            const tbody = document.getElementById("logBody");
            tbody.innerHTML = "";

            // Sort logs by dateIssued in descending order for display
            const sortedLogs = [...logs].sort((a, b) => {
                const dateA = new Date(a.dateIssued.split("/").reverse().join("-"));
                const dateB = new Date(b.dateIssued.split("/").reverse().join("-"));
                return dateB - dateA;
            });

            sortedLogs.forEach((log, sortedIndex) => {
                const originalIndex = logs.indexOf(log);
                const row = document.createElement("tr");
                row.setAttribute("data-index", originalIndex);

                // Determine status
                let statusText = "";
                let statusClass = "";
                if (log.items.length === 0) {
                    statusText = "Returned";
                    statusClass = "text-status-returned";
                } else if (log.returnedItems && log.returnedItems.length > 0) {
                    if (log.items.every(item => log.returnedItems.includes(item))) {
                        statusText = "Returned";
                        statusClass = "text-status-returned";
                    } else {
                        const returnedItemsText = log.returnedItems.join(", ");
                        statusText = `${returnedItemsText} Returned`;
                        statusClass = "text-status-partial";
                    }
                } else {
                    statusText = "Issued";
                    statusClass = "text-status-issued";
                }

                // Format return dates with item names
                let returnDateText = "";
                if (log.returnDates && log.returnDates.length > 0) {
                    returnDateText = log.returnDates.map(dateEntry => `${dateEntry.item} ${dateEntry.date}`).join("\n");
                }

                row.innerHTML = `
                    <td class="py-3 px-4 border whitespace-pre">${log.name}\n${log.place}\n${log.phone}</td>
                    <td class="py-3 px-4 border">${log.remarks || "N/A"}</td>
                    <td class="py-3 px-4 border">${log.items.join(", ")}</td>
                    <td class="py-3 px-4 border whitespace-pre">${(log.returnedItems && log.returnedItems.length > 0) ? log.returnedItems.join(", ") : ""}</td>
                    <td class="py-3 px-4 border">${log.dealer || "N/A"}</td>
                    <td class="py-3 px-4 border">${log.dateIssued}</td>
                    <td class="py-3 px-4 border whitespace-pre">${returnDateText}</td>
                    <td class="py-3 px-4 border ${statusClass} status-text">${statusText}</td>
                    <td class="py-3 px-4 border flex space-x-2">
                        <button class="edit-btn bg-primary-pink text-white px-3 py-1 rounded-lg hover:bg-primary-pink-dark transition duration-200" data-index="${originalIndex}">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-200" data-index="${originalIndex}">
                            <i class="fas fa-trash-alt mr-1"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Attach event listeners for Edit and Delete buttons using event delegation
            const logTable = document.getElementById("logTable");
            logTable.removeEventListener('click', handleTableClick); // Remove previous listener to avoid duplicates
            logTable.addEventListener('click', handleTableClick);
        }

        // Event delegation handler for Edit and Delete buttons
        function handleTableClick(event) {
            const target = event.target.closest('button');
            if (!target) return;

            const index = parseInt(target.getAttribute('data-index'));

            if (target.classList.contains('edit-btn')) {
                showEditEntryModal(index);
            } else if (target.classList.contains('delete-btn')) {
                showDeleteConfirmModal(index);
            }
        }

        // Show Delete Confirmation Modal
        function showDeleteConfirmModal(index) {
            deleteIndex = index; // Store the index for deletion
            document.getElementById("deleteConfirmModal").classList.remove("modal-hidden");
            document.getElementById("deleteConfirmModal").classList.add("modal-visible");

            // Attach event listener to the Confirm Delete button
            const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
            confirmDeleteBtn.onclick = () => {
                confirmDeleteEntry();
            };
        }

        // Close Delete Confirmation Modal
        function closeDeleteConfirmModal(event) {
            const modalContent = document.querySelector("#deleteConfirmModal .bg-white");
            if (event && !modalContent.contains(event.target)) {
                document.getElementById("deleteConfirmModal").classList.add("modal-hidden");
                document.getElementById("deleteConfirmModal").classList.remove("modal-visible");
                deleteIndex = null;
            } else if (!event) {
                document.getElementById("deleteConfirmModal").classList.add("modal-hidden");
                document.getElementById("deleteConfirmModal").classList.remove("modal-visible");
                deleteIndex = null;
            }
        }

        // Confirm Delete Entry
        function confirmDeleteEntry() {
            if (deleteIndex === null || deleteIndex < 0 || deleteIndex >= logs.length || !logs[deleteIndex]) {
                alert("Error: Entry not found.");
                closeDeleteConfirmModal();
                return;
            }

            const log = logs[deleteIndex];

            // Adjust inventory: Decrease issued count for items that are still issued
            const stillIssuedItems = log.items.filter(item => !log.returnedItems || !log.returnedItems.includes(item));
            stillIssuedItems.forEach(itemName => {
                const item = inventory.find(i => i.name === itemName);
                if (item && item.issued > 0) {
                    item.issued = Math.max(0, item.issued - 1); // Ensure issued doesn't go negative
                }
            });

            // Remove the entry from logs
            logs.splice(deleteIndex, 1);

            // Update views
            loadLogs();
            loadInventory();
            populateItemsCheckboxes();

            // Safely update the Return modal if it's open
            if (!document.getElementById("returnModal").classList.contains("modal-hidden")) {
                filterEntries();
            } else {
                // Reset Return modal state
                clearReturnForm();
                clearReturnWarnings();
            }

            alert("Entry deleted successfully!");
            closeDeleteConfirmModal();
        }

        // Show Edit Entry modal
        function showEditEntryModal(index) {
            const log = logs[index];
            document.getElementById("editEntryName").value = log.name;
            document.getElementById("editEntryPlace").value = log.place;
            document.getElementById("editEntryPhone").value = log.phone;
            document.getElementById("editEntryRemarks").value = log.remarks || "";
            document.getElementById("editEntryDealer").value = log.dealer || "";
            document.getElementById("editEntryDate").value = log.dateIssued ? `20${log.dateIssued.split("/").reverse().join("-")}` : "";

            // Populate issued items checkboxes
            const editItemsContainer = document.getElementById("editEntryItems");
            editItemsContainer.innerHTML = "";
            inventory.forEach(item => {
                const available = Math.max(0, item.total - item.issued) + (log.items.includes(item.name) ? 1 : 0); // Add back the item if it's already issued in this entry
                const isDisabled = available === 0;
                const div = document.createElement("div");
                div.className = `flex items-center ${isDisabled ? 'disabled-item' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" id="edit-item-${item.name}" value="${item.name}" class="mr-2" ${isDisabled ? 'disabled' : ''} ${log.items.includes(item.name) ? 'checked' : ''}>
                    <label for="edit-item-${item.name}">${item.name} (${available} available)</label>
                `;
                editItemsContainer.appendChild(div);
            });

            // Populate returned items checkboxes (for undoing returns)
            const editReturnedItemsContainer = document.getElementById("editReturnedItems");
            editReturnedItemsContainer.innerHTML = "";
            if (log.returnedItems && log.returnedItems.length > 0) {
                log.returnedItems.forEach(itemName => {
                    const div = document.createElement("div");
                    div.className = "flex items-center";
                    div.innerHTML = `
                        <input type="checkbox" id="edit-returned-item-${itemName}" value="${itemName}" class="mr-2" checked>
                        <label for="edit-returned-item-${itemName}">${itemName}</label>
                    `;
                    editReturnedItemsContainer.appendChild(div);
                });
            } else {
                editReturnedItemsContainer.innerHTML = `<p class="text-sm text-gray-600">No items returned.</p>`;
            }

            document.getElementById("editEntryModal").setAttribute("data-index", index);
            document.getElementById("editEntryModal").classList.remove("modal-hidden");
            document.getElementById("editEntryModal").classList.add("modal-visible");
            clearEditWarnings();
        }

        // Close Edit Entry modal
        function closeEditEntryModal(event) {
            const modalContent = document.querySelector("#editEntryModal .bg-white");
            if (event && !modalContent.contains(event.target)) {
                document.getElementById("editEntryModal").classList.add("modal-hidden");
                document.getElementById("editEntryModal").classList.remove("modal-visible");
                clearEditWarnings();
            } else if (!event) {
                document.getElementById("editEntryModal").classList.add("modal-hidden");
                document.getElementById("editEntryModal").classList.remove("modal-visible");
                clearEditWarnings();
            }
        }

        // Clear Edit warnings
        function clearEditWarnings() {
            document.getElementById("editDetailsWarning").style.display = "none";
            document.getElementById("editItemsWarning").style.display = "none";
            document.getElementById("editDateWarning").style.display = "none";
        }

        // Set today's date for Edit Issue Date
        function setTodayEditDate() {
            document.getElementById("editEntryDate").value = "2025-05-16";
        }

        // Save edited entry
        function saveEditedEntry() {
            const index = parseInt(document.getElementById("editEntryModal").getAttribute("data-index"));
            const log = logs[index];
            const name = document.getElementById("editEntryName").value.trim();
            const place = document.getElementById("editEntryPlace").value.trim();
            const phone = document.getElementById("editEntryPhone").value.trim();
            const remarks = document.getElementById("editEntryRemarks").value.trim();
            const selectedItems = Array.from(document.querySelectorAll("#editEntryItems input[type='checkbox']:checked")).map(checkbox => checkbox.value);
            const selectedReturnedItems = Array.from(document.querySelectorAll("#editReturnedItems input[type='checkbox']:checked")).map(checkbox => checkbox.value);
            const dealer = document.getElementById("editEntryDealer").value.trim();
            const dateInput = document.getElementById("editEntryDate").value;
            const dateIssued = dateInput ? new Date(dateInput).toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit", year: "2-digit" }) : "";

            // Validation
            let isValid = true;
            clearEditWarnings();

            if (!name || !place || !phone || !/^\d{10}$/.test(phone)) {
                document.getElementById("editDetailsWarning").style.display = "block";
                isValid = false;
            }
            if (!selectedItems.length) {
                document.getElementById("editItemsWarning").style.display = "block";
                isValid = false;
            }
            if (!dateInput) {
                document.getElementById("editDateWarning").style.display = "block";
                isValid = false;
            }

            // Check if selected items are available
            const originalItems = [...log.items];
            const itemsToAdd = selectedItems.filter(item => !originalItems.includes(item));
            for (const itemName of itemsToAdd) {
                const item = inventory.find(i => i.name === itemName);
                const available = Math.max(0, item.total - item.issued);
                if (available <= 0) {
                    alert(`Cannot issue ${itemName}: No stock available.`);
                    isValid = false;
                    break;
                }
            }

            if (!isValid) return;

            // Adjust inventory: Remove old issued items
            originalItems.forEach(itemName => {
                if (!selectedItems.includes(itemName)) {
                    const item = inventory.find(i => i.name === itemName);
                    if (item && item.issued > 0) {
                        item.issued -= 1;
                    }
                }
            });

            // Adjust inventory: Add new issued items
            itemsToAdd.forEach(itemName => {
                const item = inventory.find(i => i.name === itemName);
                if (item) {
                    item.issued += 1;
                }
            });

            // Adjust inventory: Handle undone returns
            const itemsToUndoReturn = (log.returnedItems || []).filter(item => !selectedReturnedItems.includes(item));
            itemsToUndoReturn.forEach(itemName => {
                const item = inventory.find(i => i.name === itemName);
                if (item) {
                    item.issued += 1; // Mark as issued again
                }
            });

            // Update the log entry
            log.name = name;
            log.place = place;
            log.phone = phone;
            log.remarks = remarks;
            log.items = selectedItems;
            log.returnedItems = selectedReturnedItems;
            log.dealer = dealer;
            log.dateIssued = dateIssued;

            // If an item was removed from returned items, remove its return date
            if (log.returnDates && itemsToUndoReturn.length > 0) {
                log.returnDates = log.returnDates.filter(dateEntry => !itemsToUndoReturn.includes(dateEntry.item));
            }

            // Update views
            loadLogs();
            loadInventory();
            populateItemsCheckboxes();
            filterEntries();
            closeEditEntryModal();
            alert("Entry updated successfully!");
        }

        // Populate items checkboxes in Add Entry modal
        function populateItemsCheckboxes() {
            const itemsContainer = document.getElementById("entryItems");
            itemsContainer.innerHTML = "";
            inventory.forEach(item => {
                const available = Math.max(0, item.total - item.issued);
                const isDisabled = available === 0;
                const div = document.createElement("div");
                div.className = `flex items-center ${isDisabled ? 'disabled-item' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" id="item-${item.name}" value="${item.name}" class="mr-2" ${isDisabled ? 'disabled' : ''}>
                    <label for="item-${item.name}">${item.name} (${available} available)</label>
                `;
                itemsContainer.appendChild(div);
            });
        }

        // Populate items radio buttons in Return modal
        function populateReturnItemsRadio() {
            const itemsContainer = document.getElementById("returnItems");
            itemsContainer.innerHTML = "";
            inventory.forEach(item => {
                const div = document.createElement("div");
                div.className = "flex items-center";
                div.innerHTML = `
                    <input type="radio" name="returnItem" id="return-item-${item.name}" value="${item.name}" class="mr-2" onchange="filterEntries()">
                    <label for="return-item-${item.name}">${item.name}</label>
                `;
                itemsContainer.appendChild(div);
            });
        }

        // Filter entries based on selected item in Return modal
        function filterEntries() {
            const selectedItem = document.querySelector("#returnItems input[type='radio']:checked")?.value;
            const entriesSelect = document.getElementById("returnEntries");
            entriesSelect.innerHTML = `<option value="">Select an entry</option>`;

            if (!selectedItem) {
                return;
            }

            // Filter logs to include entries with the selected item, excluding those where the item is already returned
            logs.forEach((log, index) => {
                const isFullyReturned = log.items.every(item => log.returnedItems && log.returnedItems.includes(item));
                const isItemReturned = log.returnedItems && log.returnedItems.includes(selectedItem);
                if (log.items.includes(selectedItem) && !isFullyReturned && !isItemReturned) {
                    const option = document.createElement("option");
                    option.value = index;
                    option.textContent = `${log.name} - ${log.place}`;
                    entriesSelect.appendChild(option);
                }
            });
        }

        // Show FAB options modal
        document.getElementById("fabBtn").addEventListener("click", () => {
            document.getElementById("fabOptionsModal").classList.toggle("modal-hidden");
            document.getElementById("fabOptionsModal").classList.toggle("modal-visible");
        });

        // Close FAB options modal when clicking outside
        function closeFabOptionsModal(event) {
            const modalContent = document.querySelector("#fabOptionsModal .bg-white");
            if (event && !modalContent.contains(event.target)) {
                document.getElementById("fabOptionsModal").classList.add("modal-hidden");
                document.getElementById("fabOptionsModal").classList.remove("modal-visible");
            }
        }

        // Close Add Entry modal when clicking outside
        function closeAddEntryModal(event) {
            const modalContent = document.querySelector("#addEntryModal .bg-white");
            if (event && !modalContent.contains(event.target)) {
                document.getElementById("addEntryModal").classList.add("modal-hidden");
                document.getElementById("addEntryModal").classList.remove("modal-visible");
                clearForm();
                clearWarnings();
            } else if (!event) {
                document.getElementById("addEntryModal").classList.add("modal-hidden");
                document.getElementById("addEntryModal").classList.remove("modal-visible");
                clearForm();
                clearWarnings();
            }
        }

        // Show Add Entry modal
        function showAddEntryModal() {
            populateItemsCheckboxes();
            document.getElementById("fabOptionsModal").classList.add("modal-hidden");
            document.getElementById("fabOptionsModal").classList.remove("modal-visible");
            document.getElementById("addEntryModal").classList.remove("modal-hidden");
            document.getElementById("addEntryModal").classList.add("modal-visible");
            clearWarnings();
        }

        // Show Return modal
        function showReturnModal() {
            populateReturnItemsRadio();
            document.getElementById("fabOptionsModal").classList.add("modal-hidden");
            document.getElementById("fabOptionsModal").classList.remove("modal-visible");
            document.getElementById("returnModal").classList.remove("modal-hidden");
            document.getElementById("returnModal").classList.add("modal-visible");
            clearReturnWarnings();
        }

        // Close Return modal
        function closeReturnModal(event) {
            const modalContent = document.querySelector("#returnModal .bg-white");
            if (event && !modalContent.contains(event.target)) {
                document.getElementById("returnModal").classList.add("modal-hidden");
                document.getElementById("returnModal").classList.remove("modal-visible");
                clearReturnForm();
                clearReturnWarnings();
            } else if (!event) {
                document.getElementById("returnModal").classList.add("modal-hidden");
                document.getElementById("returnModal").classList.remove("modal-visible");
                clearReturnForm();
                clearReturnWarnings();
            }
        }

        // Clear Return form
        function clearReturnForm() {
            document.querySelectorAll("#returnItems input[type='radio']").forEach(radio => radio.checked = false);
            const entriesSelect = document.getElementById("returnEntries");
            entriesSelect.innerHTML = `<option value="">Select an entry</option>`;
            document.getElementById("returnDate").value = "";
        }

        // Clear Return warnings
        function clearReturnWarnings() {
            document.getElementById("returnItemsWarning").style.display = "none";
            document.getElementById("returnEntryWarning").style.display = "none";
            document.getElementById("returnDateWarning").style.display = "none";
        }

        // Set today's date for Return Date
        function setTodayReturnDate() {
            document.getElementById("returnDate").value = "2025-05-16";
        }

        // Mark as Returned
        function markAsReturned() {
            const selectedItem = document.querySelector("#returnItems input[type='radio']:checked")?.value;
            const selectedEntryIndex = document.getElementById("returnEntries").value;
            const returnDate = document.getElementById("returnDate").value;
            const formattedReturnDate = returnDate ? new Date(returnDate).toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit", year: "2-digit" }) : "";

            // Validation
            let isValid = true;
            clearReturnWarnings();

            if (!selectedItem) {
                document.getElementById("returnItemsWarning").style.display = "block";
                isValid = false;
            }
            if (!selectedEntryIndex) {
                document.getElementById("returnEntryWarning").style.display = "block";
                isValid = false;
            }
            if (!returnDate) {
                document.getElementById("returnDateWarning").style.display = "block";
                isValid = false;
            }

            if (!isValid) return;

            // Find the entry and update the returned items list
            const entryIndex = parseInt(selectedEntryIndex);
            const entry = logs[entryIndex];
            if (!entry.returnedItems) {
                entry.returnedItems = [];
            }
            if (!entry.returnedItems.includes(selectedItem)) {
                entry.returnedItems.push(selectedItem);
            }
            if (!entry.returnDates) {
                entry.returnDates = [];
            }
            entry.returnDates.push({ item: selectedItem, date: formattedReturnDate });

            // Decrease the issued count in inventory
            const inventoryItem = inventory.find(i => i.name === selectedItem);
            if (inventoryItem && inventoryItem.issued > 0) {
                inventoryItem.issued -= 1;
            }

            // Update views
            loadLogs();
            loadInventory();
            closeReturnModal();
            alert("Item marked as returned successfully!");
        }

        // Clear warnings
        function clearWarnings() {
            document.getElementById("detailsWarning").style.display = "none";
            document.getElementById("itemsWarning").style.display = "none";
            document.getElementById("dateWarning").style.display = "none";
            document.getElementById("tokenWarning").style.display = "none";
        }

        // Set today's date for Issue Date
        function setTodayDate() {
            document.getElementById("entryDate").value = "2025-05-16";
        }

        // Clear form
        function clearForm() {
            document.getElementById("entryName").value = "";
            document.getElementById("entryPlace").value = "";
            document.getElementById("entryPhone").value = "";
            document.getElementById("entryRemarks").value = "";
            document.querySelectorAll("#entryItems input[type='checkbox']").forEach(checkbox => checkbox.checked = false);
            document.getElementById("entryDealer").value = "";
            document.getElementById("entryDate").value = "";
            clearWarnings();
        }

        // Add entry
        function addEntry() {
            const name = document.getElementById("entryName").value.trim();
            const place = document.getElementById("entryPlace").value.trim();
            const phone = document.getElementById("entryPhone").value.trim();
            const remarks = document.getElementById("entryRemarks").value.trim();
            const selectedItems = Array.from(document.querySelectorAll("#entryItems input[type='checkbox']:checked")).map(checkbox => checkbox.value);
            const dealer = document.getElementById("entryDealer").value.trim();
            const dateInput = document.getElementById("entryDate").value;
            const dateIssued = dateInput ? new Date(dateInput).toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit", year: "2-digit" }) : "";

            // Validation
            let isValid = true;
            clearWarnings();

            if (!name || !place || !phone || !/^\d{10}$/.test(phone)) {
                document.getElementById("detailsWarning").style.display = "block";
                isValid = false;
            }
            if (!selectedItems.length) {
                document.getElementById("itemsWarning").style.display = "block";
                isValid = false;
            }
            if (!dateInput) {
                document.getElementById("dateWarning").style.display = "block";
                isValid = false;
            }

            // Check if selected items are available
            for (const itemName of selectedItems) {
                const item = inventory.find(i => i.name === itemName);
                const available = Math.max(0, item.total - item.issued);
                if (available <= 0) {
                    alert(`Cannot issue ${itemName}: No stock available.`);
                    isValid = false;
                    break;
                }
            }

            if (!isValid) return;

            // Increment issued count in inventory
            selectedItems.forEach(itemName => {
                const item = inventory.find(i => i.name === itemName);
                if (item) {
                    item.issued += 1;
                }
            });

            // Add entry to logs
            logs.push({
                name: name,
                place: place,
                phone: phone,
                remarks: remarks,
                items: selectedItems,
                dealer: dealer,
                dateIssued: dateIssued,
                returnedItems: [],
                returnDates: []
            });

            // Update both views and close the modal
            loadLogs();
            loadInventory();
            closeAddEntryModal();
            alert("Entry added successfully! Note: To save to Google Sheets, please follow the integration steps.");
        }

        // Show/hide sections
        function showSection(section) {
            document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
            document.getElementById(`${section}Section`).classList.remove("hidden");

            // Show/hide FAB buttons based on the section
            const fabBtn = document.getElementById("fabBtn");
            const stockFabBtn = document.getElementById("stockFabBtn");
            fabBtn.style.display = (section === "register") ? "flex" : "none";
            stockFabBtn.style.display = (section === "stockInfo") ? "flex" : "none";

            // Reset edit mode when switching sections
